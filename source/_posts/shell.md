---
title: shell
date: 2024-02-11 17:21:03
tags:
- shell
description: shell
---

#### 定义

一个命令行解释器，相当于是包在内核外面的一个外壳，是底层操作系统核心和外部应用的一个接口，可以进行一些翻译和解释。

#### 简介

最初的 Shell 来自 Unix 的 Bourne Shell，但是这一个版本和用户的交互比较差。后来基于它，发展出来了 Bash Shell，目前大部分 Linux 的发行版默认的 Shell 都是 Bash Shell（红帽系都是 Bash Shell，但是 Debian 系下面的使用的是 Dash Shell）。我们可以使用命令 `echo $SHELL` 来查看当前的解释器。

对于 Shell 脚本文件，一般是 `.sh` 结尾，但是其实对于 Shell 解析的过程，我们对于文件名字没有要求，只不过约定俗称加一个 `.sh` 后缀。

#### 常见的 Shell 版本

Bash（Bourne Again Shell）、C Shell、Korn Shell 还有一些其他的 Shell 变体和实现，例如 Zsh、Fish Shell、Dash 等。

#### 常见执行方式

1. 采用 bash 或者 sh 加上脚本的相对路径或者绝对路径（不用赋予脚本 +x 权限）

2. 采用输入脚本的绝对路径或者相对路径执行脚本（必须具有可执行权限+x）（采用相对路径和绝对路径来执行的话是重新打开了一个子 bash 来执行）

3. 在路径前面加上 `source` 或者 `.` 来执行脚本（这两种方法是直接在当前的 bash 环境中执行）。

#### 变量

Shell 中的变量可以分为两大类，一大类就是系统给我们直接定义好的所有系统变量；另一大类就是用户自定义的变量。还有一种划分维度是，Shell 变量可以分为全局环境变量（对于当前的 Shell 和它里面的子对话，这个变量都是可见的）和局部环境变量（只针对当前的 Shell 是可见的，对于子 Shell 不可见）。

可以使用 set 指令来查看所有的变量。

##### 系统预定义变量

常用系统变量 $HOME $PWD $SHELL $USER

##### 自定义变量

###### 基本语法

1. 基本语法：变量名=变量值（注意，「=」前后不可以有空格，因为 shell 中，空格表示命令和参数之间的间隔）（类型并不是静态的，我们不关心变量类型）

2. 可以使用 `unset 变量名` 来撤销变量，但是 readonly 的变量不可以直接 unset

3. 我们可以使用 `readonly` 关键字来定义只读变量，`readonly b=5`，但是 b 是我们定义的一个常量，不可以直接 unset

我们定义的变量在 env 中找不到，但是在 set 中可以找到。因为 env 中可以看到的是系统帮我们定义好的全局变量，set 是包含了所有的系统定义的、用户定义的全局变量和局部变量。

我们这样直接定义的就是局部变量，可以使用 `export 变量名` 来提升为全局变量

###### 变量定义规则

1. 不能以数字开头，环境变量名建议大写

2. 在 bash 中，变量默认都是字符串类型，无法直接进行数值计算

3. 变量的值如果有空格，需要使用双引号或者单引号括起来

##### 特殊变量

1. $n 
    n 为数字，$0 表示该脚本的名称（带有路径的名字），$1-9 表示第一到第九个参数，十以上的参数，需要使用大括号包含，如 ${10}
    单引号中，不会认为 `$n` 是一个变量，但是双引号就会

2. $#
    获取我们当前输入参数的个数，常用语循环操作，判断参数的个数是否正确及增强程序的健壮性

3. $* 和 $@
    两个变量比较类似，都是获取当前脚本的所有参数。
    但是 $* 是把所有的参数看成一个整体；$@ 是把所有的参数看成一个集合，类似于数组，可以使用 for 循环来遍历

4. $?
    当前最后一次执行命令的返回状态
    如果为 0，表示正常执行结束；一般的错误是返回 1

#### 运算符

Linux Shell 中有一个专门用于计算的表达式 `expr 1 + 2`，必须有空格，相当于把 1、+、2 作为 `expr` 的参数传递进去。但是这样过于麻烦了，于是就设计了一种加上 `$` 的方法。

基本语法：`$((运算式))` 或者 `$[运算式]`，比起 expr 来讲就会简单很多，其中的运算式可以是数字和变量的任意组合。

#### 条件判断

一个编程语言少不了对于流程的控制

可以使用 `[ condition ]` 来判断，但是前后必须有空格。判断相等的时候等号两边也必须有空格，比如说 `[ $a = hello ]`。因为如果我们不加空格的话，就会把中间的 condition 认为是一体。

Linux Shell 中没有使用 `<` 或者 `>` 来进行数值判断功能的，因为 `>` 表示的是输出重定向，`<` 表示的是输入重定向。

##### 常用判断条件

1. 两个整数之间的比较
    -eq 等于 
    -ne 不等于 
    -lt 小于 
    -le 小于等于 
    -gt 大于 
    -ge 大于等于

2. 字符串之间使用 = 和 != 来判断

3. 对文件权限的判断
    -r 有读的权限 
    -w 有写的权限 
    -x 有执行的权限

4. 对文件类型进行判断
    -e 文件存在（existence）
    -f 文件存在并且是一个常规的文件 file
    -d 文件存在并且是一个目录 directory

多条件判断：使用 && 和 || 来分别表示「且」和「或」，一个比较常用的写法，例如 `[ $a -lt 20] && echo "$a < 20" || echo "$a >= 20"`

并且对于一个中括号内的多个条件判断，我们可以在中间加 -a 表示 and，-o 表示 or

#### 流程控制

是整个写一个程序的重点，程序结构主要是三大流程：顺序、分支、循环

##### if 判断

1. 单分支
    ```
    if [ condition ]; then
        程序
    fi
    ```
    或者
    ```
    if [ condition ]
    then
        程序
    fi
    ```
    别的语言一般都是使用括号来表示 if 后面的逻辑，但是在 Shell 中花括号都是有着自己的用途，所以我们不能再使用了，就是用这种 then、fi 的结构来表示 if。
    其中，第一种表示方法中的 `;` 表示的是把两个命令分开来。在 Shell 本身中，分号就是这个作用，并不是因为 if 而特殊处理。

2. 多分支
    ```
    if [ condition ]
    then
        程序
    elif [ condition ]
    then
        程序
    else
        程序
    fi
    ```
##### case 语句

##### for 循环

1. 
    ```
    for (( 初始值;循环控制条件;变量变化 ))
    then
        程序
    done
    ```

    在 `(())` 中，我们可以直接书写一些数学运算式

    一种方式：
    ```
    #!/bin/bash

    for (( i=1;i<=100;i++ ))
    do
            sum=$[ $sum + $i ]
    done

    echo $sum
    ```

2. ```
    for 变量 in 值1 值2 值3
    do
        程序
    done
    ```

    Linux 的 Shell 里面有一个内部运算符，表达式就是 `{}`，表示一个序列，这也是为什么我们不能使用它来写 if 结构和 for 结构。

    如果表示 1 到 100 的一个序列：`{1..100}`

    ```
    for i in {1..100}; do sum=$[$sum + $i]; done; echo $sum
    ```

##### while 循环

```
while [ condition ]
do
    程序
done
```

#### read 读取控制台输入

基本语法：read 选项 参数

其中，选项：
    -p: 指定读取值时的提示符
    -t: 指定读取值时的时间（秒），如果不 -t 表示一直等待

参数：指定读取值的变量名

#### 函数

Linux 中有很多系统函数，我们也可以做自定义的函数

##### basename

basename [string/pathname] [suffix] basename 命令会删除所有的前缀包括最后一个 / 字符，然后将字符串显示出来。

suffix 为后缀，如果 suffix 被指定了，basename 会将 pathname/string 中的 suffix 去掉。

##### dirname

与 basename 相反，截取最后一个 / 字符前面的路径

##### 自定义函数

上面的两个函数是两个系统函数，下面介绍一下自定义函数。

基本语法：
    ```
    [ function ]funname[()] {
        Action;
        [return int;]
    }
    ```

经验技巧：

    1. 必须在函数调用之前先声明函数，shell 脚本是逐行运行，不会像其他语言一样先进行编译

    2. 函数返回值只可以由系统变量 $? 获得，return 后跟数值 n(0-255)

示例：

```
#!/bin/bash

function add() {
        sum=$[$1 + $2]
        echo "sum is $sum"
}

read -p "enter the first number: " a

read -p "enter the second number: " b

add $a $b
```

#### 综合应用

一个归档脚本

```
#!/bin/bash

if [ $# -ne 1 ]
then 
        echo "the number of para is wrong"
        exit
fi

if [ -d $1 ]
then
        echo
else
        echo
        echo "the directory is not exist"
        exit
fi

DIR_NAME=$(basename $1)
DIR_PATH=$(cd $(dirname $1); pwd)

DATE=$(date +%y%m%d)

FILE_NAME=archive_$DIR_NAME_$DATE.tar.gz

DEST=/home/miraclys/$FILE_NAME

tar -czf $DEST $DIR_PATH/$DIR_NAME
```

#### 正则表达式

特殊字符：

    1. `^` 可以匹配一行的开头，
        ```
        cat /etc/passwd | grep ^a 
        ```
        表示匹配以 a 开头的一行

    2.`$` 匹配一行的结束

    3. `^$` 可以匹配空行

    4. `.` 可以匹配任意一个字符（除了换行符 \n）

    5. .* 可以用来表示任意字符出现任意多次

    6. [] 来表示一个字符区间 [6,8] 匹配 6 或者 8

#### 文本处理工具

##### cut

##### awk
