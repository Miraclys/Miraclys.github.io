---
title: C语言记录
date: 2024-03-04 18:23:44
tags:
- C
description: 
---

### 链接

https://wangdoc.com/clang

### I/O 函数

#### 缓存和字节流

严格来说，输入输出函数并不是直接与外部通信设备通信，而是通过缓存 buffer 进行间接通信（大概就是类似于 Cache，减少速度之间的差异带来的影响）。

普通文件一般都保存在磁盘上面，跟 CPU 相比，磁盘读取或写入数据是一个很慢的操作。所以，程序直接读写磁盘是不可行的，可能每执行一行命令，都必须等半天。C 语言的解决方案，就是只要打开一个文件，就**在内存里面为这个文件设置一个缓存区**。

程序向文件写入数据时，程序先把数据放入缓存，等到缓存满了，再把里面的数据会一次性写入磁盘文件。这时，缓存区就空了，程序再把新的数据放入缓存，重复整个过程。

程序从文件读取数据时，文件先把一部分数据放到缓存里面，然后程序从缓存获取数据，等到缓存空了，磁盘文件再把新的数据放入缓存，重复整个过程。

内存的读写速度比磁盘快得多，缓存的设计减少了读写磁盘的次数，大大提高了程序的执行效率。另外，一次性移动大块数据，要比多次移动小块数据快得多。

这种读写模式，对于程序来说，就有点像水流（stream），**不是一次性读取或写入所有数据，而是一个持续不断的过程**（流的含义或者来历）。先操作一部分数据，等到缓存吞吐完这部分数据，再操作下一部分数据。这个过程就叫做字节流操作。

#### getchar() putchar()

getchar() 从键盘获取一个字符，返回一个 int 型数值。当遇到文件结束或者出错时返回 EOF，停止读取。putchar 用于将一个字符，原型是 `int putchar(int character)` 其中 character 是要输出的 ASCII 值，返回值是输出的字符，或者发生错误的时候返回 EOF

### 文件操作

C 语言提供了一个 FILE 结构，记录了操作一个文件所需要的信息，该结构定义在头文件 stdio.h 中。

下面是一个简单的读取代码：

```
#include <stdio.h>
int main(void) {
  FILE* fp;
  char c;
  fp = fopen("hello.txt", "r");
  if (fp == NULL) {
    return -1;
  }
  c = fgetc(fp);
  printf("%c\n", c);
  fclose(fp);
  return 0;
}
```

#### 过程

fgetc()一调用，文件的数据块先拷贝到缓冲区。不同的计算机有不同的缓冲区大小，一般是512字节或是它的倍数，如4096或16384。随着计算机硬盘容量越来越大，缓冲区也越来越大。

fgetc()从缓冲区读取数据，同时将文件指针内部的读写位置指示器，指向所读取字符的下一个字符。所有的文件读取函数都使用相同的缓冲区，后面再调用任何一个读取函数，都将从指示器指向的位置，即上一次读取函数停止的位置开始读取。

当读取函数发现已读完缓冲区里面的所有字符时，会请求把下一个缓冲区大小的数据块，从文件拷贝到缓冲区中。读取函数就以这种方式，读完文件的所有内容，直到文件结尾。不过，上例是只从缓存区读取一个字符。当函数在缓冲区里面，读完文件的最后一个字符时，就把 FILE 结构里面的文件结尾指示器设置为真。于是，下一次再调用读取函数时，会返回常量 EOF。EOF 是一个整数值，代表文件结尾，一般是-1。

第三步，fclose()关闭文件，同时清空缓存区。

#### 标准流

Linux 系统默认提供三个已经打开的文件，它们的文件指针如下：

- stdin 标准输入 默认来源为键盘，文件指针编号为 0
- stdout 标准输出 默认目的地是显示器，文件指针编号是 1
- stderr 标准错误 默认目的地是显示器，文件指针编号是 2

因为 Linux 中一切皆是文件，所以文件不一定是数据文件还有可能是设备文件，即文件代表一个可以读或者写的设备。文件指针 stdin 默认是把键盘看作是一个文件，读取这一个文件，就能获取用户从键盘的输入。

我们可以改变这三个文件指针（文件流）指向的文件，这叫做重定向（redirection）

比如说对于一个可执行文件 `a.exe`，我们可以写 `a.exe < input.txt > output.txt` 表示从 input 中读取数据并把最后的结果输出到 output 中（如果是 `>> output` 表示在 output 文件最后追加，如果是 `> output` 则是清空源文件，重新从头开始输入）。

#### EOF

C 语言中文件操作函数的设计是，如果遇到文件结尾，就返回一个特殊值。程序接收到这一个特殊值，就表示结尾了。

头文件 `stdio.h` 定义了一个特殊的宏 `EOF`（End of file），它的值一般是 -1（因为不会和文件本身的数据冲突）。值得注意的是，不像字符串结尾真正存储了 `\0` 这一个值，EOF 并不存储在文件结尾，文件中并不存在这一个值，完全是文件操作函数发现到达了文件结尾，而返回这一个值 EOF

